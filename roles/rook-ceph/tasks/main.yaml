- name: Ensure rook directories to exist
  file:  # noqa 208
    path: "{{ manifest_dest }}/{{ item }}/"
    state: directory
  with_items:
    - rook-ceph
    - storage

- name: copy rook yamls to destination
  copy:
    dest: "{{ manifest_dest }}/rook-ceph/{{item}}"
    src: "{{ item }}"
  with_items:
    - 01.crds.yaml
    - 02.common.yaml
    - 05.filesystem.yaml
    - 06.toolbox.yaml

- name: generate rook template files
  template:
    lstrip_blocks: yes
    trim_blocks: yes
    dest: "{{ manifest_dest }}/rook-ceph/{{item}}"
    src: "{{item}}.j2"
  with_items:
    - 03.operator.yaml
    - 04.cluster.yaml
    - 07.dashboard-external-https.yaml

- name: deploy rook/crds.yaml
  run_once: true
  shell: "{{ bin_dir }}/kubectl apply -f {{ manifest_dest }}/rook-ceph/01.crds.yaml"

- name: deploy rook/common.yaml
  run_once: true
  shell: "{{ bin_dir }}/kubectl apply -f {{ manifest_dest }}/rook-ceph/02.common.yaml"

- include_tasks: operator.yaml

- include_tasks: cluster.yaml

- name: deploy rook/filesystem.yaml
  run_once: true
  shell: "{{ bin_dir }}/kubectl apply -f {{ manifest_dest }}/rook-ceph/05.filesystem.yaml"

- name: deploy rook/toolbox.yaml
  run_once: true
  shell: "{{ bin_dir }}/kubectl apply -f {{ manifest_dest }}/rook-ceph/06.toolbox.yaml"

- name: deploy rook/dashboard.yaml
  run_once: true
  shell: "{{ bin_dir }}/kubectl apply -f {{ manifest_dest }}/rook-ceph/07.dashboard-external-https.yaml"