- name: Ensure directories to export exist
  file:  # noqa 208
    path: "{{ item.value['nfs_path'] }}"
    state: directory
  with_dict: "{{ nfs_pv_pvc_mounts }}"

- name: export the directories editing the file /etc/exports
  lineinfile:
    dest: /etc/exports
    regexp: "^{{ item.value['nfs_path'] }} "
    line: "{{ item.value['nfs_path'] }} {{hostvars[item.value['nfs_server']]['ansible_default_ipv4'].address}}{{ nfs_export_opts }}"
    create: yes
  with_dict:
    - "{{ nfs_pv_pvc_mounts }}"
  register: nfs_exports_result

- include: "nfs-server-{{ansible_os_family}}.yaml"

- name: Ensure rpcbind is running
  service: name=rpcbind state=started enabled=yes
  when: not nfs_only_v4

- name: Restart NFS server service
  service: name={{NFS_SERVICE}} state=restarted enabled=yes
  when: nfs_exports_result is changed

- name: Check if NFS server service is started
  service: name={{NFS_SERVICE}} state=started

- name: Ensure rpcbind is stopped
  service: name=rpcbind state=stopped enabled=no
  when: nfs_only_v4

- name: Ensure rpcbind.socket is stopped
  service: name=rpcbind.socket state=stopped enabled=no
  when: ansible_os_family == "RedHat" and nfs_only_v4
